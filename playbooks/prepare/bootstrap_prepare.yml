---
# High-level playbook that calls the bootstrap_prepare role sub-tasks
# Play 1: baseline on all nodes
- name: Bootstrap new Slurm nodes (controller + compute)
  hosts: all
  become: yes
  gather_facts: yes
  roles:
    - role: bootstrap_prepare

# Play 2: create/read controller management user's SSH key
- name: Ensure controller management user has SSH key
  hosts: slurmctld
  become: yes
  gather_facts: no
  vars:
    mgmt_key_type: "rsa"
    mgmt_key_bits: 4096
  tasks:
    - name: Run controller tasks (generate & read key)
      include_role:
        name: bootstrap_prepare
        tasks_from: controller.yml

# Play 3: distribute controller public key to compute
- name: Distribute controller SSH key to compute nodes
  hosts: compute
  become: yes
  gather_facts: no
  tasks:
    - name: Distribute controller pubkey to compute nodes
      include_role:
        name: bootstrap_prepare
        tasks_from: distribute.yml

# Play 4: prime known_hosts on controller
- name: Prime known_hosts on controller for all compute nodes
  hosts: slurmctld
  become: yes
  gather_facts: no
  tasks:
    - name: Add compute nodes to known_hosts (controller)
      include_role:
        name: bootstrap_prepare
        tasks_from: known_hosts.yml

# Play 5: verify controller->compute passwordless SSH
- name: Verify controller->compute passwordless SSH
  hosts: slurmctld
  become: yes
  gather_facts: no
  tasks:
    - name: Verify SSH connectivity (controller -> compute)
      include_role:
        name: bootstrap_prepare
        tasks_from: verify.yml