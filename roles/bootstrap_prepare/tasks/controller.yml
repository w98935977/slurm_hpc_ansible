---
# Tasks to be executed on the controller (slurmctld)
- name: Ensure ~/.ssh exists on controller (management user)
  become: yes
  become_user: "{{ mgmt_user_final }}"
  ansible.builtin.file:
    path: "{{ mgmt_user_home }}/.ssh"
    state: directory
    mode: '0700'

- name: Generate SSH key if not present (controller management user)
  become: yes
  become_user: "{{ mgmt_user_final }}"
  ansible.builtin.command: >
    ssh-keygen
    -t {{ mgmt_key_type }}
    {% if mgmt_key_type == 'rsa' %}-b {{ mgmt_key_bits }}{% endif %}
    -f {{ mgmt_user_home }}/.ssh/{{ 'id_rsa' if mgmt_key_type == 'rsa' else 'id_ed25519' }}
    -N ""
  args:
    creates: "{{ mgmt_user_home }}/.ssh/{{ 'id_rsa' if mgmt_key_type == 'rsa' else 'id_ed25519' }}"

- name: Read controller's public key (management user)
  become: yes
  become_user: "{{ mgmt_user_final }}"
  ansible.builtin.slurp:
    src: "{{ mgmt_user_home }}/.ssh/{{ 'id_rsa' if mgmt_key_type == 'rsa' else 'id_ed25519' }}.pub"
  register: controller_pubkey

- name: Assert controller_pubkey was read
  ansible.builtin.assert:
    that:
      - controller_pubkey is defined
      - controller_pubkey.content is defined