#!/bin/bash
# Auto-generated by Ansible - Do not edit manually
# Restores MIG configuration for configured GPUs

# Ensure nvidia-persistenced is running
systemctl start nvidia-persistenced

# Force enable persistence mode
nvidia-smi -pm 1

{% for config in nvidia_mig_config %}
{% if config.enable_mig %}
echo "Configuring GPU {{ config.gpu_index }}..."

# 1. Enable MIG mode
nvidia-smi -i {{ config.gpu_index }} -mig 1

# 2. Clear existing instances (to ensure clean slate)
nvidia-smi mig -i {{ config.gpu_index }} --destroy-compute-instance --destroy-gpu-instance || true

# 3. Create instances
{% for profile in config.profiles %}
echo "Creating instance {{ profile }} on GPU {{ config.gpu_index }}"
nvidia-smi mig -i {{ config.gpu_index }} --create-gpu-instance {{ profile }} --create-compute-instance
{% endfor %}

{% endif %}
{% endfor %}

echo "MIG configuration restored."
