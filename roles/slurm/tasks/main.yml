---
# 安裝 Slurm 及基本外掛（利用套件取得 systemd 服務與依賴）
- name: Install distro Slurm base packages
  ansible.builtin.apt:
    name:
      - slurmctld
      - slurmd
      - slurm-wlm-basic-plugins
    state: present
    update_cache: true
    cache_valid_time: 3600
  become: true

- name: Install Slurm build/runtime dependencies (Debian)
  ansible.builtin.apt:
    name:
      - build-essential
      - git
      - pkg-config
      - python3
      - munge
      - libmunge-dev
      - libmunge2
      - libpam0g-dev
      - libhwloc-dev
      - libssl-dev
      - libcurl4-openssl-dev
      - libmysqlclient-dev
      - libpmix-dev
      - libcgroup-dev
      - libhdf5-dev
      - libncurses-dev
      - libreadline-dev
      - libevent-dev
      - libarchive-dev
      - libsystemd-dev
      - libbpf-dev
      - zlib1g-dev
      - "linux-headers-{{ ansible_kernel }}"
      - libnvidia-ml-dev
    state: present
    update_cache: true
    cache_valid_time: 3600
  when: ansible_os_family == 'Debian'
  become: true

- name: Hold distro Slurm packages to prevent downgrade/overwrite
  ansible.builtin.command: "apt-mark hold {{ item }}"
  loop:
    - slurmctld
    - slurmd
    - slurm-wlm-basic-plugins
  failed_when: false
  when: ansible_os_family == 'Debian'
  become: true

- name: Discover installed slurmd version
  ansible.builtin.command: slurmd --version
  register: slurmd_version_cmd
  changed_when: false
  failed_when: false

- name: Compute Slurm build metadata
  ansible.builtin.set_fact:
    slurm_installed_version: >-
      {{
        (slurmd_version_cmd.stdout | default('') | regex_search('([0-9]+\\.[0-9]+\\.[0-9]+)'))
          | default('')
      }}
    slurm_source_tarball: "slurm-{{ slurm_source_version }}.tar.bz2"
    slurm_source_effective_url: >-
      {{
        (slurm_source_url | default('', true)) | length > 0
          and (slurm_source_url | default('', true))
          or ('https://download.schedmd.com/slurm/slurm-' ~ slurm_source_version ~ '.tar.bz2')
      }}
    slurm_source_dir: "{{ slurm_build_root }}/slurm-{{ slurm_source_version }}"
    slurm_build_stamp: "{{ slurm_build_root }}/.slurm-built-{{ slurm_source_version }}-{{ (slurm_configure_args | trim) | hash('sha1') }}"
    slurm_plugin_dir: "{{ slurm_plugin_dir | default(slurm_plugin_dir_default) }}"

- name: Check desired cgroup plugin availability
  ansible.builtin.stat:
    path: "{{ slurm_plugin_dir }}/{{ 'cgroup_v2.so' if (slurm_cgroup_plugin | default('cgroup/v2')) == 'cgroup/v2' else 'cgroup_v1.so' }}"
  register: slurm_cgroup_plugin_stat
  changed_when: false

- name: Force rebuild when desired cgroup plugin missing
  ansible.builtin.set_fact:
    slurm_force_rebuild: true
  when:
    - (slurm_cgroup_plugin | default('cgroup/v2')) == 'cgroup/v2'
    - not (slurm_cgroup_plugin_stat.stat.exists | default(false))

- name: Decide if Slurm build is required
  ansible.builtin.set_fact:
    slurm_build_required: >-
      {{
        slurm_force_rebuild | bool
        or (slurm_installed_version | default('')) != slurm_source_version
      }}

- block:
    - name: Ensure Slurm build root exists
      ansible.builtin.file:
        path: "{{ slurm_build_root }}"
        state: directory
        mode: '0755'

    - name: Remove previous source tree when forcing rebuild
      ansible.builtin.file:
        path: "{{ slurm_source_dir }}"
        state: absent
      when: slurm_force_rebuild | bool

    - name: Download Slurm source tarball
      ansible.builtin.get_url:
        url: "{{ slurm_source_effective_url }}"
        dest: "{{ slurm_build_root }}/{{ slurm_source_tarball }}"
        mode: '0644'
        force: "{{ slurm_force_rebuild | bool }}"

    - name: Extract Slurm source tree
      ansible.builtin.unarchive:
        src: "{{ slurm_build_root }}/{{ slurm_source_tarball }}"
        dest: "{{ slurm_build_root }}"
        remote_src: true
        creates: "{{ slurm_source_dir }}"

    - name: Configure Slurm source
      ansible.builtin.command: "./configure {{ slurm_configure_args }}"
      args:
        chdir: "{{ slurm_source_dir }}"
      environment:
        CPPFLAGS: "-I/usr/src/linux-headers-{{ ansible_kernel }}/include/uapi -I/usr/src/linux-headers-{{ ansible_kernel }}/include"
        CFLAGS: "-I/usr/src/linux-headers-{{ ansible_kernel }}/include/uapi -I/usr/src/linux-headers-{{ ansible_kernel }}/include"

    - name: Build Slurm from source
      ansible.builtin.command: "make {{ slurm_make_flags }}"
      args:
        chdir: "{{ slurm_source_dir }}"
      environment:
        CPPFLAGS: "-I/usr/src/linux-headers-{{ ansible_kernel }}/include/uapi -I/usr/src/linux-headers-{{ ansible_kernel }}/include"
        CFLAGS: "-I/usr/src/linux-headers-{{ ansible_kernel }}/include/uapi -I/usr/src/linux-headers-{{ ansible_kernel }}/include"

    - name: Install Slurm from source
      ansible.builtin.command: make install
      args:
        chdir: "{{ slurm_source_dir }}"

    - name: Record custom Slurm build stamp
      ansible.builtin.file:
        path: "{{ slurm_build_stamp }}"
        state: touch
  when: slurm_build_required | bool
  become: true

- name: Read current slurm uid (if exists)
  ansible.builtin.command: "getent passwd slurm | cut -d: -f3"
  register: slurm_uid_lookup
  changed_when: false
  failed_when: false
  become: true

- name: Determine if slurm uid change is required
  ansible.builtin.set_fact:
    slurm_uid_change_required: "{{ (slurm_uid_lookup.stdout | trim | default('')) != '' and (slurm_uid_lookup.stdout | trim | int) != (slurm_user_uid | int) }}"

- name: Stop slurm services before uid change (if needed)
  ansible.builtin.service:
    name: "{{ item }}"
    state: stopped
  loop:
    - slurmctld
    - slurmd
  when:
    - slurm_user_uid is defined
    - slurm_uid_change_required | default(false)
  become: true
  failed_when: false

- name: Ensure slurm group exists (consistent gid across nodes)
  ansible.builtin.group:
    name: slurm
    system: yes
    gid: "{{ slurm_user_gid | default(omit) }}"
  become: true

# 確保 slurm 服務帳號存在（有些套件未必自帶）；強制一致的 uid/gid 供 munge 驗證
- name: Ensure slurm service account exists
  ansible.builtin.user:
    name: slurm
    system: yes
    shell: /usr/sbin/nologin
    create_home: no
    uid: "{{ slurm_user_uid | default(omit) }}"
    group: slurm
  become: true

- name: Ensure slurm runtime/log directories exist (ownership for services)
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: /run/slurm,       owner: slurm, group: slurm, mode: '0755' }
    - { path: /var/log/slurm,   owner: slurm, group: slurm, mode: '0755' }
  become: true

# 偵測常見的 PluginDir（優先使用自編譯版本）
- name: Stat common Slurm plugin directories
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - /usr/lib/x86_64-linux-gnu/slurm
    - /usr/lib/slurm
    - /usr/lib64/slurm
    - /usr/lib/x86_64-linux-gnu/slurm-wlm
  register: _plugdirs

- name: Pick first existing plugin dir (or leave undefined)
  ansible.builtin.set_fact:
    slurm_plugin_dir: >-
      {{
        (_plugdirs.results
          | selectattr('stat.exists')
          | map(attribute='stat.path')
          | list
          | first)
        | default('/usr/lib/x86_64-linux-gnu/slurm')
      }}

# ── Slurm 啟動前做 MUNGE 自我測試（較穩定） ───────────────────────────────
- block:
    - name: Generate test token (slurm preflight)
      ansible.builtin.shell: |
        set -o pipefail
        SOCKET="{{ hostvars[inventory_hostname].munge_socket_path | default('/run/munge/munge.socket') }}"
        export MUNGE_SOCKET="$SOCKET"
        /usr/bin/munge -n -t 10 > /tmp/.munge_test.token
        wc -c /tmp/.munge_test.token
      args: { executable: /bin/bash }
      register: _gen
      changed_when: false
      retries: 6
      delay: 5
      until: _gen.rc == 0
      become: true

    - name: Decode token (slurm preflight)
      ansible.builtin.shell: |
        set -o pipefail
        /usr/bin/unmunge < /tmp/.munge_test.token
      args: { executable: /bin/bash }
      register: _dec
      changed_when: false
      become: true

    - name: Assert unmunge success (slurm preflight)
      ansible.builtin.assert:
        that:
          - _dec.rc == 0
          - (_dec.stdout is search('STATUS:\\s+Success'))
        fail_msg: |
          MUNGE preflight failed on {{ inventory_hostname }}.
          --- decode rc: {{ _dec.rc }} ---
          {{ _dec.stdout | default('') }}
          {{ _dec.stderr | default('') }}
  rescue:
    - name: Dump munge service status (slurm preflight)
      ansible.builtin.shell: systemctl status munge --no-pager -l || true
      register: _svc
      changed_when: false
    - name: Show munge service status
      ansible.builtin.debug:
        var: _svc.stdout
    - name: Abort slurm preflight
      ansible.builtin.fail:
        msg: "MUNGE preflight failed; see status output above."

# ── cgroup 與 GRES 設定（讓 /dev/nvidia* 被白名單） ─────────────────────────
- name: Deploy cgroup.conf
  ansible.builtin.template:
    src: cgroup.conf.j2
    dest: /etc/slurm/cgroup.conf
    owner: root
    group: root
    mode: '0644'
  notify: "slurm config changed"
  become: true

# 計算節點偵測 GPU 張數（優先計算 MIG 實例，若無則算實體 GPU）
- name: Detect GPU count and MIG profile on compute
  ansible.builtin.shell: |
    set -o pipefail
    # Count MIG instances
    mig_info=$(/usr/bin/nvidia-smi mig -lgi 2>/dev/null | grep 'MIG')
    mig_cnt=$(echo "$mig_info" | wc -l)
    
    # Check if we actually have MIG output (wc -l outputs 0 even on empty input if piped, but grep might fail)
    if [ -z "$mig_info" ]; then mig_cnt=0; fi

    if [ "$mig_cnt" -gt 0 ]; then
      # Extract first profile name (e.g., 2g.48gb) assuming homogeneous config
      # Table format: | GPU Name Profile ... | -> | 0 MIG 2g.48gb ... |
      # awk columns: $1='|', $2='0', $3='MIG', $4='2g.48gb'
      profile=$(echo "$mig_info" | head -n 1 | awk '{print $4}')
      echo "count=$mig_cnt"
      echo "profile=$profile"
    else
      # Otherwise count physical GPUs
      phys_cnt=$(/usr/bin/nvidia-smi --query-gpu=index --format=csv,noheader 2>/dev/null | wc -l || echo 0)
      echo "count=$phys_cnt"
      echo "profile="
    fi
  args: { executable: /bin/bash }
  register: _gpu_detect
  changed_when: false
  failed_when: false
  when: "'compute' in group_names"

- name: Set GPU facts
  ansible.builtin.set_fact:
    gpu_count: "{{ (_gpu_detect.stdout_lines | select('match', '^count=') | first | split('=') | last | int) }}"
    slurm_mig_profile: "{{ (_gpu_detect.stdout_lines | select('match', '^profile=') | first | split('=') | last | trim) }}"
  when: 
    - "'compute' in group_names"
    - _gpu_detect.rc == 0

- name: Debug detected GPU info
  ansible.builtin.debug:
    msg: "Detected {{ gpu_count }} GPUs/MIGs. Profile: {{ slurm_mig_profile | default('None') }}"
  when: "'compute' in group_names"

- name: Deploy gres.conf (explicit /dev mapping)
  ansible.builtin.template:
    src: gres.conf.j2
    dest: /etc/slurm/gres.conf
    owner: root
    group: root
    mode: '0644'
  notify: "slurm config changed"
  become: true

# ── 供 slurm.conf 使用的 CPU/記憶體粗略事實 ─────────────────────────────────
- name: Derive simple CPU/memory facts for template
  ansible.builtin.set_fact:
    slurm_sockets: "{{ ansible_facts['processor_count'] | default(1) | int }}"
    slurm_cores_per_socket: "{{ ansible_facts['processor_cores'] | default(1) | int }}"
    slurm_threads_per_core: "{{ ansible_facts['processor_threads_per_core'] | default(1) | int }}"
    slurm_real_mem: >-
      {{ [ (ansible_facts['memtotal_mb'] | default(2048) | int) - 1536 , 1024 ] | max }}

# spool 目錄權限
- name: Ensure spool directories exist with correct ownership
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: '0755'
  loop:
    - { path: /var/spool/slurm,  owner: slurm, group: slurm }
    - { path: /var/spool/slurmd, owner: root,  group: root }
  become: true

# 主設定
- name: Deploy slurm.conf
  ansible.builtin.template:
    src: slurm.conf.j2
    dest: /etc/slurm/slurm.conf
    owner: root
    group: root
    mode: '0644'
  notify: "slurm config changed"
  become: true

# 角色推斷
- name: Set slurm_role automatically if not provided
  ansible.builtin.set_fact:
    slurm_role: "{{ 'controller' if 'controller' in group_names else 'compute' }}"
  when: slurm_role is not defined

# 啟動服務
- name: Enable and start slurmd on compute nodes
  ansible.builtin.service:
    name: slurmd
    state: started
    enabled: true
  when: slurm_role == "compute"
  become: true

- name: Enable and start slurmctld on controller
  ansible.builtin.service:
    name: slurmctld
    state: started
    enabled: true
  when: slurm_role == "controller"
  become: true

# 讓 controller 讀入變更（包含 GRES、cgroup）
- name: Reconfigure slurmctld (reflect new config) on controller
  ansible.builtin.command: scontrol reconfigure
  when: slurm_role == "controller"
  changed_when: true
  become: true

# 收尾：刪除暫存 token
- name: Remove temp token (slurm preflight)
  ansible.builtin.file:
    path: /tmp/.munge_test.token
    state: absent
  become: true
  failed_when: false
